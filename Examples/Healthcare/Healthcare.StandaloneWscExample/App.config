<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <configSections>
    <section name="stsConfiguration" type="Digst.OioIdws.OioWsTrust.SecurityTokenServiceClientConfigurationSection,  Digst.OioIdws.OioWsTrust, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"/>
    <section name="oioIdwsLoggingConfiguration" type="Digst.OioIdws.Common.Logging.Configuration, Digst.OioIdws.Common, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"/>
    <section name="log4net" type="log4net.Config.Log4NetConfigurationSectionHandler, log4net"/>
    <section name="system.identityModel" type="System.IdentityModel.Configuration.SystemIdentityModelSection, System.IdentityModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=B77A5C561934E089"/>
  </configSections>

  <appSettings>
    <add key="wspUrl" value="https://digst.oioidws.wsp:9090/HelloWorld" />

    <!-- UGLY warning: Due to bug in implementations (e.g. Apache cxf) and *extremely* poor design choice for WCF, URI identifiers without trailing slashes do not interoperate well. HACK: use a trailing _ (underscore) to indicate that you DO NOT want a slash appended to your URI -->
    <add key="wspEntityId" value="https://fmk/" />
    <add key="subjectCertificateThumbprint" value="c8c97200d5114f436691369e0f4ee4e9c0a0cf9c" />
  </appSettings>


  <stsConfiguration
    stsIdentifier="http://sts.sundhedsdatastyrelsen.dk/"
    bootstrapTokenFromAuthenticationTokenUrl="https://test1-cnsp.ekstern-test.nspop.dk:8443/sts3/services/employee/bootstrap"
    identityTokenFromBootstrapTokenUrl="https://test1-cnsp.ekstern-test.nspop.dk:8443/sts3/services/employee"
    serviceTokenUrl=""
    wscIdentifier="https://healthcareclient" >
    <stsCertificate storeLocation="LocalMachine" storeName="TrustedPeople" x509FindType="FindByThumbprint" findValue="af7691346492dc30d127d85537297d702993176c" />
    <wscCertificate storeLocation="LocalMachine" storeName="My" x509FindType="FindByThumbprint" findValue="0e6dbcc6efaaff72e3f3d824e536381b26deecf5" />
  </stsConfiguration>

  <system.diagnostics>
    <sources>
      <source propagateActivity="false" name="System.ServiceModel" switchValue="Verbose">
        <listeners>
          <add name="ServiceModelMessageLoggingListener">
            <filter type=""/>
          </add>
        </listeners>
      </source>
      <source name="System.ServiceModel.MessageLogging" switchValue="Verbose">
        <listeners>
          <add name="ServiceModelMessageLoggingListener">
            <filter type=""/>
          </add>
        </listeners>
      </source>
      <!--
    Placed at:
      * "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\machine.config"
      
      in order to enable logKnownPii the machine.config must also be updated with
    
      <system.serviceModel>
        <machineSettings enableLoggingKnownPii="true"/>
      </system.serviceModel>
    
      logKnownPii makes it possible to see the concrete value which the digest value represent in a SignedInfo reference element.
    -->
      <source name="System.IdentityModel" switchValue="Verbose">
        <listeners>
          <add name="ServiceModelMessageLoggingListener">
            <filter type=""/>
          </add>
        </listeners>
      </source>
      <source name="Digst.OioIdws" switchValue="Information">
        <listeners>
          <add name="ServiceModelMessageLoggingListener">
            <filter type=""/>
          </add>
        </listeners>
      </source>

      <source name="System.Security.Cryptography.Xml.SignedXml" switchName="XmlDsigLogSwitch">
        <listeners>
          <add name="ServiceModelMessageLoggingListener"/>
        </listeners>
      </source>

    </sources>

    <switches>
      <add name="Saml2SecurityTokenHandlerLogSwitch" value="Verbose"/>
      <add name="XmlDsigLogSwitch" value="Verbose"/>
    </switches>

    <trace autoflush="true">
      <listeners>
        <add name="ServiceModelMessageLoggingListener"/>
      </listeners>
    </trace>

    <sharedListeners>
      <add initializeData="C:\temp\Digst.OioIdws.WscLocalSignature.svclog" type="System.Diagnostics.XmlWriterTraceListener, System, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" name="ServiceModelMessageLoggingListener" traceOutputOptions="Timestamp">
        <filter type=""/>
      </add>
    </sharedListeners>
  </system.diagnostics>

  <oioIdwsLoggingConfiguration logger="Digst.OioIdws.WscLocalSignature.Log4NetLogger, Digst.OioIdws.WscLocalSignature"/>

  <startup>
    <supportedRuntime sku=".NETFramework,Version=v4.5.2" version="v4.0"/>
  </startup>

  <system.serviceModel>
    <diagnostics>
      <messageLogging logEntireMessage="true" logMalformedMessages="true" logMessagesAtServiceLevel="true" logMessagesAtTransportLevel="true"/>
    </diagnostics>
    <extensions>
      <bindingExtensions>
        <add name="SoapBinding" type="Digst.OioIdws.Soap.Bindings.SoapBindingCollectionElement, Digst.OioIdws.Soap"/>
      </bindingExtensions>
      <behaviorExtensions>
        <add name="SoapBehavior" type="Digst.OioIdws.Soap.Behaviors.SoapClientBehaviorExtensionElement, Digst.OioIdws.Soap"/>
      </behaviorExtensions>
    </extensions>
    <behaviors>
      <endpointBehaviors>
        <behavior name="SoapBehaviourConfiguration">
          <clientCredentials useIdentityConfiguration="true">
            <serviceCertificate>
              <defaultCertificate findValue="1F0830937C74B0567D6B05C07B6155059D9B10C7" storeLocation="LocalMachine" storeName="My" x509FindType="FindByThumbprint"/>
            </serviceCertificate>
          </clientCredentials>
          <!--Endpoints can only point to a single behaviour configuration. Hence, we need to include the SoapBehavior in a existing behavior-->
          <SoapBehavior/>
        </behavior>
      </endpointBehaviors>
    </behaviors>
    <bindings>
      <ws2007HttpBinding>
        <binding name="Binding1">
          <security mode="TransportWithMessageCredential" />
        </binding>
      </ws2007HttpBinding>
      <SoapBinding>
        <binding name="SoapBindingConfiguration" useHttps="true" useSTRTransform="true" />
      </SoapBinding>
    </bindings>
    <client>
      <endpoint address="https://test1.fmk.netic.dk/proxy/services/fmk_xua_144"
        binding="SoapBinding" bindingConfiguration="SoapBindingConfiguration"
        contract="MedicineCard.MedicineCardPortType" name="MedicineCardPort">
        <identity>
          <dns value="fmk.dk" />
          <certificate encodedValue="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" />
        </identity>
      </endpoint>
    </client>
  </system.serviceModel>

  <system.identityModel>
    <identityConfiguration>
      <securityTokenHandlers>
        <!-- OIOIDWS: Use an extended Saml2 assertion handler intead of the built-in handler. The extended handler can handle complex xml-based attribute values -->
        <remove type="System.IdentityModel.Tokens.Saml2SecurityTokenHandler, System.IdentityModel, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"/>
        <add type="Digst.OioIdws.SecurityTokens.Tokens.ExtendedSaml2SecurityToken.ExtendedSaml2SecurityTokenHandler, Digst.OioIdws.SecurityTokens"/>
      </securityTokenHandlers>
    </identityConfiguration>
  </system.identityModel>

  <log4net>
    <appender name="Console" type="log4net.Appender.ConsoleAppender">
      <layout type="log4net.Layout.PatternLayout">
        <!-- Pattern to output the caller's file name and line number -->
        <conversionPattern value="%5level [%thread] (%file:%line) - %message%newline" />
      </layout>
    </appender>

    <appender name="RollingFile" type="log4net.Appender.RollingFileAppender">
      <file value="c:\temp\oioidws.log" />
      <appendToFile value="true" />
      <maximumFileSize value="100KB" />
      <maxSizeRollBackups value="2" />

      <layout type="log4net.Layout.PatternLayout">
        <conversionPattern value="%level %thread %logger - %message%newline" />
      </layout>
    </appender>

    <root>
      <level value="DEBUG" />
      <appender-ref ref="Console" />
      <appender-ref ref="RollingFile" />
    </root>
  </log4net>
</configuration>
